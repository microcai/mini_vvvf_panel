
# miniVFD 的上位机软件


MINI VFD 面板控制协议：


1. 使用 UART 通用串口，或者 RS485 作为底层传输。

2. 数据包定义为 [长度][命令ID][数据][checksum]
	长度 为 4bit，命令 ID 为 4bit. 长度是整个数据包的长度。因此最低为2个字节，最大16字节。

	控制器收到第一个字节后，会等待最多 1.5ms 获得剩余的 1-15 字节数据。
	如果超时没读取到，则会认为收到了一个错误的数据包头。这意味着串口速率最低
	为 115200。

3. checksum 为校验和，将 [长度][命令ID][数据] 里的每一个字节都加起来，然后取最终结果的最低 8位。

4. 命令定义如下：

	1 = SET_MOTOR_CFG: 设置电机参数。剩下的 14个字节为电机的参数配置结构体。

	2 = GET_RUN_INFO: 获取变频器运行状态。发送2字节。返回 14 字节为变频器状态。这是总线上最常交互的数据包。用于屏幕信息显示。

	3 = SET_TARGET: 设置运行目标。剩下字节为目标配置结构体。按设定可以配置为 设定扭矩/设定转速/设定频率/设定角度。开环V/F控制时，只能设定频率。使用何种目标配置结构体取决于数据包长度。返回 CMD_REPLY

	4 = STOP: 停止变频器。携带 1 字节数据。停止请求原因。将决定是 立即停止输出，还是逐渐降低输出。返回 CMD_REPLY

	5 = LINK_TEST: 总数据长度为 5 字节。携带 3 字节数据。数据内容为3个 0x7A。返回同理。
	这个用于初次握手。确定串口速率。串口速率由面板决定。面板以何种速率发送 LINK_TEST, 控制版就会将串口运行在何种速度。控制板在最长 0.5s 的时间内，没有收到任何数据，就会进入自动速率探测模式。
	因此，面板如果要重置通信速率，只要 0.5s 内不发送任何信息，即可重置控制板进入速率探测模式。
	然后 以 5ms - 100ms 之间的间隔 发送 LINK_TEST 直到读取到控制器返回。
	之后面板就要以最长 250ms 为间隔，向控制板发送数据。也可以在无数据需求的情况下，重复发送 LINK_TEST. 正常来说，面板会以 10ms 的间隔发送 GET_RUN_INFO 获取状态并更新到屏幕上。

	6 = CMD_REPLY: 命令的响应。3个字节。状态 0 表示成功.



4.1. SET_TARGET 命令 详解
	SET_TARGET 可以设置单一目标。由 4bit 目标类型 + 20bit 目标构成。因此整个数据包为 5 字节。
	struct {
		uint8_t header = 0x53;
		uint8_t target_type:4; // 目标类型, 目前只实现了 类型 0, 也就是频率设置
		uint8_t target_high4:4; // 目标的最高 4位
		uint8_t target_mid8; // 目标 中间的8位
		uint8_t target_low8; // 目标 最低 8位
		uint8_t checksum;
	};

	20bit 目标是一个 20bit 的有符号整数，分辨率为 0.01hz。要设置 50hz 目标就传 target = 5000。


目前只实现了 SET_TARGET/LINK_TEST。



